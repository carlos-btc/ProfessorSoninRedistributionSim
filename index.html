<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Political Economy of Redistribution Simulation</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect x='6' y='14' width='6' height='12' fill='%234A90E2'/><rect x='20' y='20' width='6' height='6' fill='%23F5A623'/><path d='M 9 10 C 9 4, 23 4, 23 16' stroke='%2334D399' fill='none' stroke-width='2.5' stroke-linecap='round'/><path d='M 23 20 L 23 16 L 19 16' stroke='%2334D399' fill='none' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.3.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.3.1/core.js"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .input-group input {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-6">
    <div class="container mx-auto space-y-8">
        <header class="text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Political Economy of Redistribution</h1>
            <p class="text-gray-600 text-lg">A dynamic game-theoretical model simulation based on Diermeier, Egorov, and Sonin (2016).</p>
        </header>

        <section id="controls" class="chart-container space-y-4">
            <h2 class="text-2xl font-bold text-gray-700">Simulation Parameters</h2>
            <p class="text-red-500" id="error-message"></p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 text-gray-700">
                <div class="input-group">
                    <label for="num-players">Number of Players:</label>
                    <input type="number" id="num-players" value="5" min="2">
                    <p class="text-xs text-gray-500 mt-1">The total number of players participating in the game.</p>
                </div>
                <div class="input-group">
                    <label for="initial-wealth">Initial Wealth (comma-separated):</label>
                    <input type="text" id="initial-wealth" value="1,2,3,4,0">
                    <p class="text-xs text-gray-500 mt-1">The starting wealth for each player. Must be a list of numbers matching the number of players.</p>
                </div>
                <div class="input-group">
                    <label for="veto-players">Veto Players (comma-separated IDs):</label>
                    <input type="text" id="veto-players" value="5">
                    <p class="text-xs text-gray-500 mt-1">The player IDs (starting from 1) who hold veto power. These players are always part of a winning coalition.</p>
                </div>
                <div class="input-group">
                    <label for="majority-threshold">Majority Threshold:</label>
                    <input type="number" id="majority-threshold" value="3" min="1">
                    <p class="text-xs text-gray-500 mt-1">The minimum number of votes required for a proposal to pass.</p>
                </div>
                <div class="input-group">
                    <label for="foresight-depth">Foresight Depth:</label>
                    <input type="number" id="foresight-depth" value="2" min="0">
                    <p class="text-xs text-gray-500 mt-1">The number of future periods players consider when making a voting decision. A value of 0 means players are shortsighted.</p>
                </div>
                <div class="input-group">
                    <label for="beta">Beta (Discount Factor):</label>
                    <input type="number" id="beta" value="0.95" step="0.01" min="0" max="1">
                    <p class="text-xs text-gray-500 mt-1">The discount factor that represents how much players value future wealth compared to immediate wealth.</p>
                </div>
                <div class="input-group">
                    <label for="temperature">Temperature:</label>
                    <input type="number" id="temperature" value="1.0" step="0.1" min="0.1">
                    <p class="text-xs text-gray-500 mt-1">A parameter for the MCMC voting process. A lower temperature leads to more deterministic (rational) voting, while a higher temperature introduces more randomness.</p>
                </div>
                <div class="input-group col-span-1 md:col-span-2">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="enable-floor" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="enable-floor" class="font-bold">Implement Minimum Floor:</label>
                        <input type="number" id="minimum-floor" value="1" min="0" class="w-24 p-1 border rounded-md disabled:bg-gray-200" disabled>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">If enabled, no player's wealth can fall below this specified value during redistribution.</p>
                </div>
                 <div class="input-group col-span-1 md:col-span-2">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="enable-shocks" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="enable-shocks" class="font-bold">Enable Economic Shocks:</label>
                        <input type="number" id="shock-magnitude" value="2" min="0" class="w-24 p-1 border rounded-md disabled:bg-gray-200" disabled>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">If enabled, each player's wealth is randomly adjusted each period by up to this percentage.</p>
                </div>
            </div>
            <div class="flex justify-center mt-6">
                <button id="run-button" class="py-2 px-6 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors duration-200 disabled:bg-gray-400">Run Simulation</button>
            </div>
            <div id="loading-indicator" class="hidden text-center mt-4 space-y-2">
                <div class="flex items-center justify-center space-x-2">
                    <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-600">Running simulation... Please wait.</p>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-sm text-gray-500">0%</p>
            </div>
            <div id="param-display" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
                <div id="param-num-players-display" class="rounded-lg p-3 bg-gray-50 border border-gray-200"></div>
                <div id="param-initial-wealth-display" class="rounded-lg p-3 bg-gray-50 border border-gray-200"></div>
                <div id="param-veto-players-display" class="rounded-lg p-3 bg-gray-50 border border-gray-200"></div>
                <div id="param-majority-threshold-display" class="rounded-lg p-3 bg-gray-50 border border-gray-200"></div>
                <div id="param-foresight-depth-display" class="rounded-lg p-3 bg-gray-50 border border-gray-200"></div>
                <div id="param-beta-display" class="rounded-lg p-3 bg-gray-50 border border-gray-200"></div>
                <div id="param-temperature-display" class="rounded-lg p-3 bg-gray-50 border border-gray-200"></div>
                <div id="param-blocking-size-display" class="rounded-lg p-3 bg-gray-50 border border-gray-200"></div>
                <div id="param-min-floor-display" class="rounded-lg p-3 bg-gray-50 border border-gray-200"></div>
                <div id="param-shocks-display" class="rounded-lg p-3 bg-gray-50 border border-gray-200"></div>
            </div>
        </section>

        <section id="visualization" class="space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="chart-container" id="chart-1-container">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Initial State of the Model</h2>
                    <img id="initial-state-chart" class="w-full h-auto">
                </div>
                <div class="chart-container" id="chart-2-container">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Final Wealth Distribution</h2>
                    <img id="final-wealth-chart" class="w-full h-auto">
                </div>
            </div>

            <div class="chart-container" id="chart-3-container">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Wealth Evolution Over Time</h2>
                <img id="wealth-evolution-chart" class="w-full h-auto">
            </div>

            <div class="chart-container" id="chart-4-container">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Proposals and Outcomes</h2>
                <img id="proposals-chart" class="w-full h-auto">
            </div>
        </section>

        <section id="output" class="chart-container">
            <h2 class="text-2xl font-bold text-gray-700">Simulation Output Log</h2>
            <pre id="log-output" class="bg-gray-800 text-gray-200 p-4 mt-4 rounded-lg overflow-x-auto text-sm"></pre>
        </section>
    </div>
    <py-config>
        packages = ["numpy", "matplotlib"]
    </py-config>
    <py-script>
import random
import math
import js
from collections import Counter
import io
import base64
import numpy as np
import matplotlib
matplotlib.use('agg')
import matplotlib.pyplot as plt
from matplotlib.figure import Figure
from matplotlib.backends.backend_agg import FigureCanvasAgg
import asyncio
from pyodide.ffi import create_proxy
    
# A global list to store log messages
log_messages = []

def log_to_js(message):
    log_messages.append(message)
    js.document.getElementById('log-output').textContent = "\n".join(log_messages)

class Player:
    """Represents a player in the game."""
    def __init__(self, player_id, is_veto=False):
        self.player_id = player_id
        self.is_veto = is_veto
        self.wealth = 0

    def __repr__(self):
        return f"P{self.player_id}(Veto={self.is_veto}, Wealth={self.wealth})"

def check_winning_coalition(coalition, veto_players, majority_threshold):
    """
    Checks if a coalition is winning based on the majority threshold and veto players.
    
    A winning coalition must:
    1. Include all veto players.
    2. Have a size greater than or equal to the majority threshold.
    """
    coalition_ids = {p.player_id for p in coalition}
    veto_ids = {p.player_id for p in veto_players}
    
    if not veto_ids.issubset(coalition_ids):
        return False
    
    if len(coalition) < majority_threshold:
        return False
        
    return True

def find_blocking_coalition_size(num_players, num_veto_players, majority_threshold):
    return num_players - majority_threshold + 1

def calculate_utility_recursive(player_id, current_allocation, foresight_depth, beta, players, veto_players, majority_threshold, minimum_floor):
    if foresight_depth <= 0:
        return current_allocation[player_id - 1]
    
    current_payoff = current_allocation[player_id - 1]
    
    if not veto_players:
        return sum(current_payoff * (beta**i) for i in range(foresight_depth + 1))

    next_proposer = random.choice(veto_players)
    next_proposed_allocation = list(current_allocation)
    
    non_veto_players = sorted([p for p in players if not p.is_veto], key=lambda p: next_proposed_allocation[p.player_id-1])
    num_non_veto_partners = majority_threshold - len(veto_players)
    coalition_partners = []
    if num_non_veto_partners > 0:
        coalition_partners = non_veto_players[-num_non_veto_partners:]
        
    non_coalition_members = [p for p in non_veto_players if p not in coalition_partners]
    expropriated_players = non_coalition_members
    
    expropriated_wealth = 0
    for p in expropriated_players:
        wealth_to_take = max(0, next_proposed_allocation[p.player_id - 1] - minimum_floor)
        expropriated_wealth += wealth_to_take
        next_proposed_allocation[p.player_id - 1] -= wealth_to_take

    next_proposed_allocation[next_proposer.player_id - 1] += expropriated_wealth
    
    future_utility = calculate_utility_recursive(
        player_id,
        next_proposed_allocation,
        foresight_depth - 1,
        beta,
        players,
        veto_players,
        majority_threshold,
        minimum_floor
    )
    
    return current_payoff + beta * future_utility

def propose_and_vote(players, current_allocation, majority_threshold, veto_players, blocking_coalition_size, beta, temperature, foresight_depth, minimum_floor):
    if not veto_players:
        return current_allocation, "No veto players available to make a proposal."

    proposer = random.choice(veto_players)
    
    non_veto_players = sorted([p for p in players if not p.is_veto], key=lambda p: p.wealth)
    
    num_non_veto_partners = majority_threshold - len(veto_players)
    
    coalition_partners = []
    if num_non_veto_partners > 0:
        coalition_partners = non_veto_players[-num_non_veto_partners:]
        
    non_coalition_members = [p for p in non_veto_players if p not in coalition_partners]
    expropriated_players = non_coalition_members
    
    proposed_allocation = list(current_allocation)
    
    expropriated_wealth = 0
    for p in expropriated_players:
        wealth_to_take = max(0, current_allocation[p.player_id - 1] - minimum_floor)
        expropriated_wealth += wealth_to_take
        proposed_allocation[p.player_id - 1] -= wealth_to_take
    
    proposed_allocation[proposer.player_id - 1] += expropriated_wealth
    
    log_to_js(f"  Proposer P{proposer.player_id} proposes the new allocation: {[round(x, 2) for x in proposed_allocation]}")
    log_to_js(f"  Proposed Coalition: {[p.player_id for p in veto_players] + [p.player_id for p in coalition_partners]}")
    
    votes = {}
    
    for player in players:
        utility_yes = calculate_utility_recursive(player.player_id, proposed_allocation, foresight_depth, beta, players, veto_players, majority_threshold, minimum_floor)
        utility_no = calculate_utility_recursive(player.player_id, current_allocation, foresight_depth, beta, players, veto_players, majority_threshold, minimum_floor)
        
        # Numerically stable softmax for voting probability
        max_utility = max(utility_yes, utility_no)
        exp_yes = math.exp((utility_yes - max_utility) / temperature)
        exp_no = math.exp((utility_no - max_utility) / temperature)
        prob_yes = exp_yes / (exp_yes + exp_no)
        
        if random.random() < prob_yes:
            votes[player] = "YES"
        else:
            votes[player] = "NO"
    
    yes_votes = [p for p, vote in votes.items() if vote == "YES"]
    
    if check_winning_coalition(yes_votes, veto_players, majority_threshold):
        return proposed_allocation, "Proposal accepted."
    else:
        return current_allocation, "Proposal rejected. Allocation remains the same."

def run_simulation(num_players, initial_wealth, majority_threshold, veto_player_ids, total_wealth, beta, temperature, foresight_depth, minimum_floor, enable_shocks, shock_magnitude):
    log_messages.clear()
    log_to_js("--- Starting Simulation ---")
    log_to_js(f"Initial State: {initial_wealth}")
    
    js.document.getElementById('param-num-players-display').innerHTML = f"<strong>Number of Players:</strong> {num_players}"
    js.document.getElementById('param-initial-wealth-display').innerHTML = f"<strong>Initial Wealth:</strong> {initial_wealth}"
    js.document.getElementById('param-veto-players-display').innerHTML = f"<strong>Veto Players:</strong> {veto_player_ids}"
    js.document.getElementById('param-majority-threshold-display').innerHTML = f"<strong>Majority Threshold:</strong> {majority_threshold}"
    js.document.getElementById('param-foresight-depth-display').innerHTML = f"<strong>Foresight Depth:</strong> {foresight_depth}"
    js.document.getElementById('param-beta-display').innerHTML = f"<strong>Discount Factor ($beta$):</strong> {beta}"
    js.document.getElementById('param-temperature-display').innerHTML = f"<strong>Temperature:</strong> {temperature}"
    js.document.getElementById('param-min-floor-display').innerHTML = f"<strong>Minimum Floor:</strong> {'Enabled (' + str(minimum_floor) + ')' if minimum_floor > 0 else 'Disabled'}"
    js.document.getElementById('param-shocks-display').innerHTML = f"<strong>Economic Shocks:</strong> {'Enabled (' + str(shock_magnitude) + '%)' if enable_shocks else 'Disabled'}"

    
    players = [Player(i + 1) for i in range(num_players)]
    for player_id in veto_player_ids:
        if 1 <= player_id <= num_players:
            players[player_id - 1].is_veto = True
    
    current_allocation = list(initial_wealth)
    for i, wealth in enumerate(current_allocation):
        players[i].wealth = wealth
    
    blocking_coalition_size = find_blocking_coalition_size(num_players, len(veto_player_ids), majority_threshold)
    js.document.getElementById('param-blocking-size-display').innerHTML = f"<strong>Blocking Coalition Size:</strong> {blocking_coalition_size}"

    wealth_history = [list(initial_wealth)]
    proposals_history = []
    
    period = 1
    STABILITY_WINDOW = 10
    STABILITY_THRESHOLD = 0.05
    MAX_PERIODS = 200

    while period <= MAX_PERIODS:
        log_to_js(f"\nPeriod {period}")
        
        progress = min(100, (period / MAX_PERIODS) * 100)
        js.document.getElementById('progress-bar').style.width = f'{progress}%'
        js.document.getElementById('progress-text').textContent = f'{math.floor(progress)}%'

        if enable_shocks and period > 1:
            log_to_js(f"  Applying economic shocks (magnitude: {shock_magnitude}%)")
            for i in range(len(current_allocation)):
                shock_factor = 1 + (random.uniform(-shock_magnitude, shock_magnitude) / 100)
                current_allocation[i] = max(0, current_allocation[i] * shock_factor)
            log_to_js(f"  Shocked Allocation: {[round(x, 2) for x in current_allocation]}")


        for i, wealth in enumerate(current_allocation):
            players[i].wealth = wealth
            
        proposer_log = random.choice([p for p in players if p.is_veto]) if any(p.is_veto for p in players) else None
        
        if proposer_log:
            new_allocation, status = propose_and_vote(players, current_allocation, majority_threshold, [p for p in players if p.is_veto], blocking_coalition_size, beta, temperature, foresight_depth, minimum_floor)
            
            proposals_history.append({
                'period': period,
                'proposer': proposer_log.player_id,
                'gain': new_allocation[proposer_log.player_id - 1] - current_allocation[proposer_log.player_id - 1],
                'accepted': new_allocation != current_allocation
            })
            
            current_allocation = new_allocation
            wealth_history.append(list(current_allocation))
            
            log_to_js(f"  Resulting Allocation: {[round(x, 2) for x in current_allocation]}")
            log_to_js(f"  Status: {status}")
        else:
            log_to_js("  No veto player available to propose. Skipping period.")
            wealth_history.append(list(current_allocation))
        
        if period > STABILITY_WINDOW and not enable_shocks: # Only check for stability if shocks are off
            recent_wealths = np.array(wealth_history[-STABILITY_WINDOW:])
            wealth_std_devs = np.std(recent_wealths, axis=0)
            if np.all(wealth_std_devs < STABILITY_THRESHOLD):
                log_to_js(f"\nStable equilibrium achieved after {period} periods. Stopping simulation.")
                js.document.getElementById('progress-bar').style.width = '100%'
                js.document.getElementById('progress-text').textContent = '100%'
                break
        
        period += 1
        if period > MAX_PERIODS:
            log_to_js(f"\nSimulation ended after {MAX_PERIODS} periods.")
            js.document.getElementById('progress-bar').style.width = '100%'
            js.document.getElementById('progress-text').textContent = '100%'
            break

    return players, initial_wealth, current_allocation, wealth_history, proposals_history

def get_base64_image(fig):
    buffer = io.BytesIO()
    canvas = FigureCanvasAgg(fig)
    canvas.print_png(buffer)
    buffer.seek(0)
    img_b64 = base64.b64encode(buffer.getvalue()).decode('utf-8')
    plt.close(fig)
    return f"data:image/png;base64,{img_b64}"

def create_initial_state_chart(players, initial_wealth):
    fig, ax = plt.subplots(figsize=(8, 5), dpi=100)
    player_labels = [f"P{p.player_id}" for p in players]
    colors = ['#4A90E2' if p.is_veto else '#F5A623' for p in players]
    
    ax.bar(player_labels, initial_wealth, color=colors)
    ax.set_title("Initial Wealth Distribution", fontsize=16)
    ax.set_xlabel("Player", fontsize=12)
    ax.set_ylabel("Wealth", fontsize=12)
    ax.set_ylim(0, max(initial_wealth) + 1 if initial_wealth else 1)
    
    veto_patch = plt.Rectangle((0, 0), 1, 1, fc='#4A90E2', label='Veto Player')
    non_veto_patch = plt.Rectangle((0, 0), 1, 1, fc='#F5A623', label='Non-Veto Player')
    ax.legend(handles=[veto_patch, non_veto_patch], loc='upper right')
    
    return get_base64_image(fig)

def create_final_wealth_chart(players, final_wealth):
    fig, ax = plt.subplots(figsize=(8, 5), dpi=100)
    player_labels = [f"P{p.player_id}" for p in players]
    colors = ['#4A90E2' if p.is_veto else '#F5A623' for p in players]
    
    ax.bar(player_labels, final_wealth, color=colors)
    ax.set_title("Final Wealth Distribution", fontsize=16)
    ax.set_xlabel("Player", fontsize=12)
    ax.set_ylabel("Wealth", fontsize=12)
    ax.set_ylim(0, max(final_wealth) + 1 if final_wealth else 1)
    
    veto_patch = plt.Rectangle((0, 0), 1, 1, fc='#4A90E2', label='Veto Player')
    non_veto_patch = plt.Rectangle((0, 0), 1, 1, fc='#F5A623', label='Non-Veto Player')
    ax.legend(handles=[veto_patch, non_veto_patch], loc='upper right')
    
    return get_base64_image(fig)

def create_wealth_evolution_chart(players, wealth_history):
    fig, ax = plt.subplots(figsize=(10, 6), dpi=100)
    num_periods = len(wealth_history)
    
    for i, player in enumerate(players):
        wealth_values = [p[i] for p in wealth_history]
        ax.plot(range(num_periods), wealth_values, label=f"Player {player.player_id}", marker='o', linestyle='--')
        
    ax.set_title("Wealth Evolution Over Time", fontsize=16)
    ax.set_xlabel("Period", fontsize=12)
    ax.set_ylabel("Wealth", fontsize=12)
    ax.legend(loc='upper left', bbox_to_anchor=(1, 1))
    ax.grid(True, linestyle='--', alpha=0.6)
    fig.tight_layout()
    
    return get_base64_image(fig)

def create_proposals_chart(proposals_history):
    fig, ax = plt.subplots(figsize=(10, 6), dpi=100)
    
    if not proposals_history:
        ax.text(0.5, 0.5, 'No proposals were made.', horizontalalignment='center', verticalalignment='center', transform=ax.transAxes)
        ax.set_title("Proposer's Gains and Proposal Outcomes", fontsize=16)
        return get_base64_image(fig)

    periods = [p['period'] for p in proposals_history]
    gains = [p['gain'] for p in proposals_history]
    accepted = [p['accepted'] for p in proposals_history]
    
    accepted_x = [periods[i] for i, val in enumerate(accepted) if val]
    accepted_y = [gains[i] for i, val in enumerate(accepted) if val]
    rejected_x = [periods[i] for i, val in enumerate(accepted) if not val]
    rejected_y = [gains[i] for i, val in enumerate(accepted) if not val]
    
    ax.scatter(accepted_x, accepted_y, color='green', label='Proposal Accepted', s=50)
    ax.scatter(rejected_x, rejected_y, color='red', label='Proposal Rejected', s=50, marker='x')

    ax.set_title("Proposer's Gains and Proposal Outcomes", fontsize=16)
    ax.set_xlabel("Period", fontsize=12)
    ax.set_ylabel("Proposed Gain", fontsize=12)
    ax.legend()
    ax.grid(True, linestyle='--', alpha=0.6)
    
    return get_base64_image(fig)

async def run_with_params(event=None):
    run_button = js.document.getElementById('run-button')
    loading_indicator = js.document.getElementById('loading-indicator')
    progress_bar = js.document.getElementById('progress-bar')
    progress_text = js.document.getElementById('progress-text')

    run_button.disabled = True
    loading_indicator.classList.remove('hidden')
    progress_bar.style.width = '0%'
    progress_text.textContent = '0%'
    
    await asyncio.sleep(0) # Allow UI to update

    try:
        # Clear previous outputs and errors
        js.document.getElementById('error-message').textContent = ''
        js.document.getElementById('log-output').textContent = ''

        num_players = int(js.document.getElementById('num-players').value)
        initial_wealth_str = js.document.getElementById('initial-wealth').value
        veto_players_str = js.document.getElementById('veto-players').value
        majority_threshold = int(js.document.getElementById('majority-threshold').value)
        foresight_depth = int(js.document.getElementById('foresight-depth').value)
        beta = float(js.document.getElementById('beta').value)
        temperature = float(js.document.getElementById('temperature').value)
        
        enable_floor = js.document.getElementById('enable-floor').checked
        minimum_floor = 0
        if enable_floor:
            minimum_floor = int(js.document.getElementById('minimum-floor').value)

        enable_shocks = js.document.getElementById('enable-shocks').checked
        shock_magnitude = 0
        if enable_shocks:
            shock_magnitude = float(js.document.getElementById('shock-magnitude').value)


        if not initial_wealth_str:
            raise ValueError("Initial wealth cannot be empty.")
        initial_wealth = tuple(map(int, initial_wealth_str.split(',')))
        if len(initial_wealth) != num_players:
            raise ValueError("Number of players must match the number of wealth values.")
        if majority_threshold < 1 or majority_threshold > num_players:
            raise ValueError("Majority threshold must be between 1 and the number of players.")

        veto_player_ids = []
        if veto_players_str:
            veto_player_ids = [int(i) for i in veto_players_str.split(',')]
            for player_id in veto_player_ids:
                if not 1 <= player_id <= num_players:
                    raise ValueError(f"Veto player ID {player_id} is out of bounds.")
        
        total_wealth = sum(initial_wealth)

        players, initial_wealth_tuple, final_allocation, wealth_history, proposals_history = run_simulation(
            num_players, initial_wealth, majority_threshold, veto_player_ids, total_wealth, beta, temperature, foresight_depth, minimum_floor, enable_shocks, shock_magnitude
        )
        
        js.document.getElementById('initial-state-chart').src = create_initial_state_chart(players, initial_wealth_tuple)
        js.document.getElementById('final-wealth-chart').src = create_final_wealth_chart(players, final_allocation)
        js.document.getElementById('wealth-evolution-chart').src = create_wealth_evolution_chart(players, wealth_history)
        js.document.getElementById('proposals-chart').src = create_proposals_chart(proposals_history)

    except ValueError as e:
        js.document.getElementById('error-message').textContent = f"Input Error: {e}"
    except Exception as e:
        js.document.getElementById('error-message').textContent = f"An unexpected error occurred: {e}"
    finally:
        loading_indicator.classList.add('hidden')
        run_button.disabled = False

# Bind the button click event
js.document.getElementById('run-button').onclick = create_proxy(run_with_params)

# Initial UI setup for the checkbox
enable_floor_checkbox = js.document.getElementById('enable-floor')
minimum_floor_input = js.document.getElementById('minimum-floor')

def setup_floor_input(event):
    minimum_floor_input.disabled = not enable_floor_checkbox.checked

enable_floor_checkbox.onchange = create_proxy(setup_floor_input)

enable_shocks_checkbox = js.document.getElementById('enable-shocks')
shock_magnitude_input = js.document.getElementById('shock-magnitude')

def setup_shocks_input(event):
    shock_magnitude_input.disabled = not enable_shocks_checkbox.checked

enable_shocks_checkbox.onchange = create_proxy(setup_shocks_input)


# Run with default parameters on page load
asyncio.ensure_future(run_with_params())
</py-script>
</body>
</html>

